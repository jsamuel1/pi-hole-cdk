{
  "Resources": {
    "piholepwd34137309": {
      "Type": "AWS::SecretsManager::Secret",
      "Properties": {
        "GenerateSecretString": {
          "ExcludePunctuation": true,
          "IncludeSpace": false
        },
        "Name": "pihole-pwd"
      },
      "UpdateReplacePolicy": "Delete",
      "DeletionPolicy": "Retain",
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/piholepwd/Resource"
      }
    },
    "piholefs1C36A016": {
      "Type": "AWS::EFS::FileSystem",
      "Properties": {
        "Encrypted": true,
        "FileSystemTags": [
          {
            "Key": "Name",
            "Value": "pihole-fs"
          }
        ]
      },
      "UpdateReplacePolicy": "Retain",
      "DeletionPolicy": "Retain",
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/pihole-fs/Resource"
      }
    },
    "piholefsEfsSecurityGroup4C4BA10A": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "PiHoleCdkStack/pihole-fs/EfsSecurityGroup",
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow all outbound traffic by default",
            "IpProtocol": "-1"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "pihole-fs"
          }
        ],
        "VpcId": "vpc-059f0682110d6ff0d"
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/pihole-fs/EfsSecurityGroup/Resource"
      },
      "DeletionPolicy": "Retain"
    },
    "piholefsEfsSecurityGroupfromPiHoleCdkStackallowdnshttp93FF3AA5204967329FD2": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "Description": "from PiHoleCdkStackallowdnshttp93FF3AA5:2049",
        "FromPort": 2049,
        "GroupId": {
          "Fn::GetAtt": [
            "piholefsEfsSecurityGroup4C4BA10A",
            "GroupId"
          ]
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Fn::GetAtt": [
            "allowdnshttp207E8443",
            "GroupId"
          ]
        },
        "ToPort": 2049
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/pihole-fs/EfsSecurityGroup/from PiHoleCdkStackallowdnshttp93FF3AA5:2049"
      },
      "DeletionPolicy": "Retain"
    },
    "piholefsEfsMountTarget12A295CA7": {
      "Type": "AWS::EFS::MountTarget",
      "Properties": {
        "FileSystemId": {
          "Ref": "piholefs1C36A016"
        },
        "SecurityGroups": [
          {
            "Fn::GetAtt": [
              "piholefsEfsSecurityGroup4C4BA10A",
              "GroupId"
            ]
          }
        ],
        "SubnetId": "subnet-0a94cd53487c5f005"
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/pihole-fs/EfsMountTarget1"
      },
      "DeletionPolicy": "Retain"
    },
    "piholefsEfsMountTarget264414D77": {
      "Type": "AWS::EFS::MountTarget",
      "Properties": {
        "FileSystemId": {
          "Ref": "piholefs1C36A016"
        },
        "SecurityGroups": [
          {
            "Fn::GetAtt": [
              "piholefsEfsSecurityGroup4C4BA10A",
              "GroupId"
            ]
          }
        ],
        "SubnetId": "subnet-0ecf5cb127062f1e3"
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/pihole-fs/EfsMountTarget2"
      },
      "DeletionPolicy": "Retain"
    },
    "piholefsEfsMountTarget327AA9833": {
      "Type": "AWS::EFS::MountTarget",
      "Properties": {
        "FileSystemId": {
          "Ref": "piholefs1C36A016"
        },
        "SecurityGroups": [
          {
            "Fn::GetAtt": [
              "piholefsEfsSecurityGroup4C4BA10A",
              "GroupId"
            ]
          }
        ],
        "SubnetId": "subnet-051a58b14db331cca"
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/pihole-fs/EfsMountTarget3"
      },
      "DeletionPolicy": "Retain"
    },
    "allowdnshttp207E8443": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "AllowDNSandSSHfrommyIP",
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow all outbound traffic by default",
            "IpProtocol": "-1"
          }
        ],
        "VpcId": "vpc-059f0682110d6ff0d"
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/allow_dns_http/Resource"
      },
      "DeletionPolicy": "Retain"
    },
    "allowdnshttpfromIndirectPeer22FDED347F": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "Description": "Allow_SSH",
        "FromPort": 22,
        "GroupId": {
          "Fn::GetAtt": [
            "allowdnshttp207E8443",
            "GroupId"
          ]
        },
        "IpProtocol": "tcp",
        "SourcePrefixListId": {
          "Fn::GetAtt": [
            "rfc1918prefix",
            "PrefixListId"
          ]
        },
        "ToPort": 22
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/allow_dns_http/from {IndirectPeer}:22"
      },
      "DeletionPolicy": "Retain"
    },
    "allowdnshttpfromIndirectPeer280F12452E4": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "Description": "Allow_HTTP",
        "FromPort": 80,
        "GroupId": {
          "Fn::GetAtt": [
            "allowdnshttp207E8443",
            "GroupId"
          ]
        },
        "IpProtocol": "tcp",
        "SourcePrefixListId": {
          "Fn::GetAtt": [
            "rfc1918prefix",
            "PrefixListId"
          ]
        },
        "ToPort": 80
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/allow_dns_http/from '{IndirectPeer2}':80"
      },
      "DeletionPolicy": "Retain"
    },
    "allowdnshttpfromIndirectPeer353D7731FAA": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "Description": "Allow_DNS_over_TCP",
        "FromPort": 53,
        "GroupId": {
          "Fn::GetAtt": [
            "allowdnshttp207E8443",
            "GroupId"
          ]
        },
        "IpProtocol": "tcp",
        "SourcePrefixListId": {
          "Fn::GetAtt": [
            "rfc1918prefix",
            "PrefixListId"
          ]
        },
        "ToPort": 53
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/allow_dns_http/from '{IndirectPeer3}':53"
      },
      "DeletionPolicy": "Retain"
    },
    "allowdnshttpfromIndirectPeer4UDP5353D41634": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "Description": "Allow_DNS_over_UDP",
        "FromPort": 53,
        "GroupId": {
          "Fn::GetAtt": [
            "allowdnshttp207E8443",
            "GroupId"
          ]
        },
        "IpProtocol": "udp",
        "SourcePrefixListId": {
          "Fn::GetAtt": [
            "rfc1918prefix",
            "PrefixListId"
          ]
        },
        "ToPort": 53
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/allow_dns_http/from '{IndirectPeer4}':UDP 53"
      },
      "DeletionPolicy": "Retain"
    },
    "allowdnshttpfromIndirectPeer5ICMPType8C3163C3D": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "Description": "Allow ICMP Ping",
        "FromPort": 8,
        "GroupId": {
          "Fn::GetAtt": [
            "allowdnshttp207E8443",
            "GroupId"
          ]
        },
        "IpProtocol": "icmp",
        "SourcePrefixListId": {
          "Fn::GetAtt": [
            "rfc1918prefix",
            "PrefixListId"
          ]
        },
        "ToPort": -1
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/allow_dns_http/from '{IndirectPeer5}':ICMP Type 8"
      },
      "DeletionPolicy": "Retain"
    },
    "rfc1918prefix": {
      "Type": "AWS::EC2::PrefixList",
      "Properties": {
        "AddressFamily": "IPv4",
        "Entries": [
          {
            "Cidr": "10.0.0.0/8",
            "Description": "RFC1918 10/8"
          },
          {
            "Cidr": "172.16.0.0/12",
            "Description": "RFC1918 172.16/12"
          },
          {
            "Cidr": "192.168.0.0/16",
            "Description": "RFC1918 192.168/16"
          }
        ],
        "MaxEntries": 3,
        "PrefixListName": "RFC1918"
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/rfc1918prefix"
      },
      "DeletionPolicy": "Retain"
    },
    "piholerole45D2AA68": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition"
                },
                ":iam::aws:policy/AmazonSSMManagedInstanceCore"
              ]
            ]
          },
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition"
                },
                ":iam::aws:policy/AmazonElasticFileSystemClientReadWriteAccess"
              ]
            ]
          },
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition"
                },
                ":iam::aws:policy/AmazonSSMPatchAssociation"
              ]
            ]
          },
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition"
                },
                ":iam::aws:policy/CloudWatchAgentServerPolicy"
              ]
            ]
          }
        ],
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "secretsmanager:DescribeSecret",
                    "secretsmanager:GetResourcePolicy",
                    "secretsmanager:GetSecretValue",
                    "secretsmanager:ListSecretVersionIds"
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Ref": "piholepwd34137309"
                  }
                },
                {
                  "Action": "secretsmanager:ListSecrets",
                  "Effect": "Allow",
                  "Resource": "*"
                }
              ],
              "Version": "2012-10-17"
            },
            "PolicyName": "secretPolicy"
          },
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "kms:Decrypt",
                    "kms:DescribeKey",
                    "kms:Encrypt",
                    "kms:GenerateDataKey*",
                    "kms:ReEncrypt*"
                  ],
                  "Effect": "Allow",
                  "Resource": "*"
                }
              ],
              "Version": "2012-10-17"
            },
            "PolicyName": "kmsPolicy"
          }
        ]
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/pihole-role/Resource"
      },
      "DeletionPolicy": "Retain"
    },
    "piholeasglaunchtemplateProfile79BDF81F": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Roles": [
          {
            "Ref": "piholerole45D2AA68"
          }
        ]
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/pihole-asg-launchtemplate/Profile"
      },
      "DeletionPolicy": "Retain"
    },
    "piholeasglaunchtemplate35F914B9": {
      "Type": "AWS::EC2::LaunchTemplate",
      "Properties": {
        "LaunchTemplateData": {
          "IamInstanceProfile": {
            "Arn": {
              "Fn::GetAtt": [
                "piholeasglaunchtemplateProfile79BDF81F",
                "Arn"
              ]
            }
          },
          "ImageId": {
            "Ref": "SsmParameterValueawsservicecanonicalubuntuserver2204stablecurrentarm64hvmebsgp2amiidC96584B6F00A464EAD1953AFF4B05118Parameter"
          },
          "InstanceType": "t4g.small",
          "KeyName": "pihole",
          "MetadataOptions": {
            "HttpTokens": "required"
          },
          "SecurityGroupIds": [
            {
              "Fn::GetAtt": [
                "allowdnshttp207E8443",
                "GroupId"
              ]
            }
          ],
          "TagSpecifications": [
            {
              "ResourceType": "instance",
              "Tags": [
                {
                  "Key": "Name",
                  "Value": "PiHoleCdkStack/pihole-asg-launchtemplate"
                }
              ]
            },
            {
              "ResourceType": "volume",
              "Tags": [
                {
                  "Key": "Name",
                  "Value": "PiHoleCdkStack/pihole-asg-launchtemplate"
                }
              ]
            }
          ],
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "#!/bin/bash\nSECRET_ARN=",
                  {
                    "Ref": "piholepwd34137309"
                  },
                  "\nEFS_ID=",
                  {
                    "Ref": "piholefs1C36A016"
                  },
                  "\nREV_SERVER_CIDR=192.168.0.0/16\nREV_SERVER_TARGET=192.168.1.1\n#!/bin/bash -x\n# Pi-hole v6 installation script\n# This script installs Pi-hole v6 which includes an embedded web server\n# No longer requires lighttpd or PHP as Pi-hole v6 has these built-in\n# \n# log user data output to /var/log/user-data.log\nexec > >(tee /var/log/user-data.log | logger -t user-data -s 2>/dev/console) 2>&1\n\n# Function to log with timestamp\nlog_message() {\n    echo \"[$(date '+%Y-%m-%d %H:%M:%S')] $1\"\n}\n\n# Function to retry commands with exponential backoff\nretry_command() {\n    local max_attempts=5\n    local delay=1\n    local attempt=1\n    \n    while [ $attempt -le $max_attempts ]; do\n        log_message \"Attempt $attempt of $max_attempts: $*\"\n        if \"$@\"; then\n            log_message \"Command succeeded: $*\"\n            return 0\n        else\n            log_message \"Command failed: $*\"\n            if [ $attempt -lt $max_attempts ]; then\n                log_message \"Waiting ${delay}s before retry...\"\n                sleep $delay\n                delay=$((delay * 2))\n            fi\n            attempt=$((attempt + 1))\n        fi\n    done\n    \n    log_message \"Command failed after $max_attempts attempts: $*\"\n    return 1\n}\n\nlog_message \"Starting Pi-hole v6 installation userdata script\"\n\n# upgrade packages\nlog_message \"Updating package lists and upgrading system\"\nretry_command apt update -y\nretry_command apt upgrade -y\n\n# Install essential packages (removed lighttpd, php-* packages, but kept Lua)\nlog_message \"Installing required packages\"\nretry_command apt install -y dialog unzip idn2 dns-root-data jq git binutils make wget python3-pip curl\n\n# Install Lua packages (still needed for web interface extensions and processing)\nlog_message \"Installing Lua packages for web interface processing\"\nretry_command apt install -y lua5.1 liblua5.1-0-dev lua-cjson\n\n# not amazon linux, so need to build the package\nlog_message \"Building and installing EFS utils\"\nretry_command git clone https://github.com/aws/efs-utils /tmp/efs-utils/\ncd /tmp/efs-utils\nretry_command ./build-deb.sh\nretry_command apt -y install ./build/amazon-efs-utils*deb\nretry_command pip3 install botocore --upgrade\n\n# Create pihole directory and setup EFS mount with proper error handling\nlog_message \"Setting up EFS mount for Pi-hole configuration\"\nmkdir -p /etc/pihole/\necho \"$EFS_ID:/ /etc/pihole/ efs _netdev,noresvport,tls,iam,nofail 0 0\" >>/etc/fstab\n\n# Retry EFS mount with better error handling\nlog_message \"Mounting EFS filesystem\"\nif ! retry_command mount -av; then\n    log_message \"EFS mount failed, but continuing with local storage\"\n    # Ensure directory exists even if EFS mount fails\n    mkdir -p /etc/pihole/\nfi\n\n# Verify EFS mount status\nif mountpoint -q /etc/pihole; then\n    log_message \"EFS successfully mounted to /etc/pihole\"\nelse\n    log_message \"WARNING: EFS not mounted, using local storage\"\nfi\n\n# Configure Pi-hole v6 settings using environment variables (preferred method)\nlog_message \"Setting Pi-hole v6 configuration via environment variables\"\n\n# Create environment file for Pi-hole FTL configuration\ncat > /etc/environment << EOF\n# Pi-hole v6 Configuration via Environment Variables\nFTLCONF_dns_upstreams=1.1.1.1,1.0.0.1,2606:4700:4700::1111,2606:4700:4700::1001\nFTLCONF_dns_listeningMode=all\nFTLCONF_dns_dnssec=false\nFTLCONF_dns_bogusPriv=false\nFTLCONF_dns_fqdnRequired=false\nFTLCONF_dns_queryLogging=true\nFTLCONF_dns_revServer_enabled=true\nFTLCONF_dns_revServer_cidr=$REV_SERVER_CIDR\nFTLCONF_dns_revServer_target=$REV_SERVER_TARGET\nFTLCONF_dns_revServer_domain=localdomain\nFTLCONF_webserver_port_http=80\nFTLCONF_webserver_port_https=443\nEOF\n\n# Source the environment variables\nsource /etc/environment\n\n# Setup initial blocklists for v6\nlog_message \"Setting up initial Pi-hole blocklists\"\nif [ ! -a /etc/pihole/adlists.list ]; then\n\tcat <<EOF >/etc/pihole/adlists.list\nhttps://raw.githubusercontent.com/StevenBlack/hosts/master/hosts\nhttps://v.firebog.net/hosts/Admiral.txt\nhttps://v.firebog.net/hosts/Easylist.txt\nhttps://v.firebog.net/hosts/Easyprivacy.txt\nhttps://v.firebog.net/hosts/Prigent-Ads.txt\nhttps://raw.githubusercontent.com/Perflyst/PiHoleBlocklist/master/SmartTV.txt\nEOF\nfi\n\n# Stop any existing lighttpd service (in case it's running from previous installations)\nlog_message \"Stopping any existing lighttpd service\"\nsystemctl stop lighttpd 2>/dev/null || true\nsystemctl disable lighttpd 2>/dev/null || true\n\n# Install Pi-hole v6 unattended\nlog_message \"Installing Pi-hole v6\"\nretry_command wget -O /tmp/basic-install.sh https://install.pi-hole.net\nretry_command bash /tmp/basic-install.sh --unattended\n\n# Install AWS CLI\nlog_message \"Installing AWS CLI\"\nretry_command snap install aws-cli --channel=v2/candidate --classic\n\n# Wait for AWS CLI to be available\nlog_message \"Waiting for AWS CLI to be available\"\nsleep 10\n\n# Set the Pi-hole web UI password\nlog_message \"Setting Pi-hole web UI password from Secrets Manager\"\nif retry_command aws secretsmanager get-secret-value --secret-id $SECRET_ARN; then\n    PASSWORD=$(aws secretsmanager get-secret-value --secret-id $SECRET_ARN | jq .SecretString -j)\n    /usr/local/bin/pihole -a -p \"$PASSWORD\"\n    log_message \"Pi-hole password set successfully\"\nelse\n    log_message \"WARNING: Failed to retrieve password from Secrets Manager\"\nfi\n\n# Apply whitelist\nlog_message \"Applying common whitelists\"\nif retry_command git clone https://github.com/anudeepND/whitelist.git /tmp/whitelist/; then\n    python3 /tmp/whitelist/scripts/whitelist.py\n    log_message \"Whitelist applied successfully\"\nelse\n    log_message \"WARNING: Failed to apply whitelist\"\nfi\n\n# Configure Pi-hole v6 settings using the command line interface\nlog_message \"Configuring Pi-hole v6 settings via command line\"\n\n# Set DNS upstream servers\n/usr/local/bin/pihole-FTL --config dns.upstreams \"1.1.1.1,1.0.0.1,2606:4700:4700::1111,2606:4700:4700::1001\" || true\n\n# Set listening mode to all interfaces (restricted by security groups)\n/usr/local/bin/pihole-FTL --config dns.listeningMode all || true\n\n# Configure reverse DNS settings\n/usr/local/bin/pihole-FTL --config dns.revServer.enabled true || true\n/usr/local/bin/pihole-FTL --config dns.revServer.cidr \"$REV_SERVER_CIDR\" || true\n/usr/local/bin/pihole-FTL --config dns.revServer.target \"$REV_SERVER_TARGET\" || true\n/usr/local/bin/pihole-FTL --config dns.revServer.domain \"localdomain\" || true\n\n# Enable query logging\n/usr/local/bin/pihole-FTL --config dns.queryLogging true || true\n\n# Configure web server ports (Pi-hole v6 embedded server)\n/usr/local/bin/pihole-FTL --config webserver.port.http 80 || true\n/usr/local/bin/pihole-FTL --config webserver.port.https 443 || true\n\n# Start and enable Pi-hole FTL service\nlog_message \"Starting Pi-hole FTL service\"\nsystemctl restart pihole-FTL\nsystemctl enable pihole-FTL\n\n# Wait for service to start\nsleep 10\n\n# Verify Pi-hole FTL service is running\nlog_message \"Verifying Pi-hole FTL service status\"\nif systemctl is-active --quiet pihole-FTL; then\n    log_message \"Pi-hole FTL is running successfully\"\nelse\n    log_message \"WARNING: Pi-hole FTL failed to start\"\n    systemctl status pihole-FTL\nfi\n\n# Verify web interface is accessible on port 80\nlog_message \"Verifying Pi-hole v6 web interface accessibility\"\nsleep 5\nif curl -s -f http://localhost/admin/ >/dev/null 2>&1; then\n    log_message \"Pi-hole v6 web interface is accessible on port 80\"\nelif curl -s -f http://localhost:8080/admin/ >/dev/null 2>&1; then\n    log_message \"Pi-hole v6 web interface is accessible on port 8080 (fallback)\"\nelse\n    log_message \"WARNING: Pi-hole v6 web interface is not accessible\"\nfi\n\n# Test DNS functionality\nlog_message \"Testing DNS functionality\"\nif dig @127.0.0.1 google.com +short >/dev/null 2>&1; then\n    log_message \"DNS functionality test passed\"\nelse\n    log_message \"WARNING: DNS functionality test failed\"\nfi\n\n# Display Pi-hole v6 configuration summary\nlog_message \"Pi-hole v6 configuration summary:\"\n/usr/local/bin/pihole-FTL --config --list 2>/dev/null || log_message \"Could not retrieve configuration list\"\n\n# Check which ports Pi-hole is listening on\nlog_message \"Checking Pi-hole listening ports:\"\nnetstat -tlnp | grep pihole-FTL || log_message \"Could not determine listening ports\"\n\nlog_message \"Pi-hole v6 installation userdata script completed successfully\"\n"
                ]
              ]
            }
          }
        },
        "TagSpecifications": [
          {
            "ResourceType": "launch-template",
            "Tags": [
              {
                "Key": "Name",
                "Value": "PiHoleCdkStack/pihole-asg-launchtemplate"
              }
            ]
          }
        ]
      },
      "DependsOn": [
        "piholerole45D2AA68"
      ],
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/pihole-asg-launchtemplate/Resource"
      },
      "DeletionPolicy": "Retain"
    },
    "piholeasgASG8930D123": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "HealthCheckType": "EC2",
        "LaunchTemplate": {
          "LaunchTemplateId": {
            "Ref": "piholeasglaunchtemplate35F914B9"
          },
          "Version": {
            "Fn::GetAtt": [
              "piholeasglaunchtemplate35F914B9",
              "LatestVersionNumber"
            ]
          }
        },
        "MaxInstanceLifetime": 604800,
        "MaxSize": "1",
        "MinSize": "1",
        "TargetGroupARNs": [
          {
            "Ref": "nlbNLBDNSpiholesTargetsGroup9190EAB9"
          }
        ],
        "VPCZoneIdentifier": [
          "subnet-0a94cd53487c5f005",
          "subnet-0ecf5cb127062f1e3",
          "subnet-051a58b14db331cca"
        ]
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "SuspendProcesses": [
            "HealthCheck",
            "ReplaceUnhealthy",
            "AZRebalance",
            "AlarmNotification",
            "ScheduledActions",
            "InstanceRefresh"
          ]
        },
        "AutoScalingScheduledAction": {
          "IgnoreUnmodifiedGroupSizeProperties": true
        }
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/pihole-asg/ASG"
      },
      "DeletionPolicy": "Retain"
    },
    "nlbC39469D4": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "LoadBalancerAttributes": [
          {
            "Key": "deletion_protection.enabled",
            "Value": "false"
          },
          {
            "Key": "load_balancing.cross_zone.enabled",
            "Value": "true"
          }
        ],
        "Name": "pihole",
        "Scheme": "internal",
        "Subnets": [
          "subnet-0a94cd53487c5f005",
          "subnet-0ecf5cb127062f1e3",
          "subnet-051a58b14db331cca"
        ],
        "Type": "network"
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/nlb/Resource"
      },
      "DeletionPolicy": "Retain"
    },
    "nlbNLBDNSBD4A1316": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "DefaultActions": [
          {
            "TargetGroupArn": {
              "Ref": "nlbNLBDNSpiholesTargetsGroup9190EAB9"
            },
            "Type": "forward"
          }
        ],
        "LoadBalancerArn": {
          "Ref": "nlbC39469D4"
        },
        "Port": 53,
        "Protocol": "TCP_UDP"
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/nlb/NLBDNS/Resource"
      },
      "DeletionPolicy": "Retain"
    },
    "nlbNLBDNSpiholesTargetsGroup9190EAB9": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "Port": 53,
        "Protocol": "TCP_UDP",
        "TargetGroupAttributes": [
          {
            "Key": "deregistration_delay.timeout_seconds",
            "Value": "120"
          },
          {
            "Key": "deregistration_delay.connection_termination.enabled",
            "Value": "true"
          }
        ],
        "TargetType": "instance",
        "VpcId": "vpc-059f0682110d6ff0d"
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/nlb/NLBDNS/piholesTargetsGroup/Resource"
      },
      "DeletionPolicy": "Retain"
    },
    "GetEndpointIps4AECBE9C": {
      "Type": "Custom::AWS",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "AWS679f53fac002430cb0da5b7982bd22872D164C4C",
            "Arn"
          ]
        },
        "Create": {
          "Fn::Join": [
            "",
            [
              "{\"service\":\"EC2\",\"action\":\"describeNetworkInterfaces\",\"parameters\":{\"Filters\":[{\"Name\":\"description\",\"Values\":[\"ELB ",
              {
                "Fn::GetAtt": [
                  "nlbC39469D4",
                  "LoadBalancerFullName"
                ]
              },
              "\"]}]},\"physicalResourceId\":{\"id\":\"GetEndpointIps\"},\"outputPaths\":[\"NetworkInterfaces.0.PrivateIpAddress\",\"NetworkInterfaces.1.PrivateIpAddress\",\"NetworkInterfaces.2.PrivateIpAddress\"]}"
            ]
          ]
        },
        "Update": {
          "Fn::Join": [
            "",
            [
              "{\"service\":\"EC2\",\"action\":\"describeNetworkInterfaces\",\"parameters\":{\"Filters\":[{\"Name\":\"description\",\"Values\":[\"ELB ",
              {
                "Fn::GetAtt": [
                  "nlbC39469D4",
                  "LoadBalancerFullName"
                ]
              },
              "\"]}]},\"physicalResourceId\":{\"id\":\"GetEndpointIps\"},\"outputPaths\":[\"NetworkInterfaces.0.PrivateIpAddress\",\"NetworkInterfaces.1.PrivateIpAddress\",\"NetworkInterfaces.2.PrivateIpAddress\"]}"
            ]
          ]
        },
        "InstallLatestAwsSdk": false
      },
      "DependsOn": [
        "GetEndpointIpsCustomResourcePolicy50BCB4EC",
        "nlbNLBDNSpiholesTargetsGroup9190EAB9",
        "nlbNLBDNSBD4A1316",
        "nlbC39469D4"
      ],
      "UpdateReplacePolicy": "Delete",
      "DeletionPolicy": "Retain",
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/GetEndpointIps/Resource/Default"
      }
    },
    "GetEndpointIpsCustomResourcePolicy50BCB4EC": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "ec2:DescribeNetworkInterfaces",
              "Effect": "Allow",
              "Resource": "*"
            }
          ],
          "Version": "2012-10-17"
        },
        "PolicyName": "GetEndpointIpsCustomResourcePolicy50BCB4EC",
        "Roles": [
          {
            "Ref": "AWS679f53fac002430cb0da5b7982bd2287ServiceRoleC1EA0FF2"
          }
        ]
      },
      "DependsOn": [
        "nlbNLBDNSpiholesTargetsGroup9190EAB9",
        "nlbNLBDNSBD4A1316",
        "nlbC39469D4"
      ],
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/GetEndpointIps/CustomResourcePolicy/Resource"
      },
      "DeletionPolicy": "Retain"
    },
    "AWS679f53fac002430cb0da5b7982bd2287ServiceRoleC1EA0FF2": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition"
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
              ]
            ]
          }
        ]
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/AWS679f53fac002430cb0da5b7982bd2287/ServiceRole/Resource"
      },
      "DeletionPolicy": "Retain"
    },
    "AWS679f53fac002430cb0da5b7982bd22872D164C4C": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": "cdk-hnb659fds-assets-717494614307-ap-southeast-2",
          "S3Key": "c099eb4e32cbf1c3da9c45a3b280efe2bed38d27d74aa72702b67d86d1b52354.zip"
        },
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "AWS679f53fac002430cb0da5b7982bd2287ServiceRoleC1EA0FF2",
            "Arn"
          ]
        },
        "Runtime": "nodejs22.x",
        "Timeout": 120
      },
      "DependsOn": [
        "AWS679f53fac002430cb0da5b7982bd2287ServiceRoleC1EA0FF2"
      ],
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/AWS679f53fac002430cb0da5b7982bd2287/Resource",
        "aws:asset:path": "asset.c099eb4e32cbf1c3da9c45a3b280efe2bed38d27d74aa72702b67d86d1b52354",
        "aws:asset:is-bundled": false,
        "aws:asset:property": "Code"
      },
      "DeletionPolicy": "Retain"
    },
    "CDKMetadata": {
      "Type": "AWS::CDK::Metadata",
      "Properties": {
        "Analytics": "v2:deflate64:H4sIAAAAAAAA/31STU/DMAz9LdyzsI0LHDckENKAaeU+ealbzFJnih3GVPW/o2ZdBRw4+X1YL5bjuZ1PZ3Z6BUeZuHI/8bSzbaHg9maDElJ0aOAo21bQRVRpgKHGaNsic3Nf8Rl1Biux7QN5LE6i2PTWb/YcEusbxDp3u3kOSZH09BhDOgxZ/whPXEcU6fV1xIq+ViRqVpDYvb9hc/Cg2Ju/lc4QNLbdBJ/NS31iUWCH6xgq8mjWwZM75eyMOgNJgzjwxLVtF0lDcSbjcH+1zqAHUXI+QLkDD+yI68+5bV9QjyHuVwHKZdYx5kF/8ksPiSIP/gUP3nl54/s/aGc8NLsSbFsQ1x418ENipxTYjKD/kQF3Rm62IIIqdtEXIzd2mdwedQmCXd4DRGhQMRqXREOzjcNFiF0c5T5r45H8pRWPOOcXCjVx3RuvSQ9JO8OhRPsh15+zWzu7s9OrDyGaxMRKDdrNuX4DdB04T6ECAAA="
      },
      "Metadata": {
        "aws:cdk:path": "PiHoleCdkStack/CDKMetadata/Default"
      },
      "DeletionPolicy": "Retain"
    }
  },
  "Parameters": {
    "SsmParameterValueawsservicecanonicalubuntuserver2204stablecurrentarm64hvmebsgp2amiidC96584B6F00A464EAD1953AFF4B05118Parameter": {
      "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
      "Default": "/aws/service/canonical/ubuntu/server/22.04/stable/current/arm64/hvm/ebs-gp2/ami-id"
    },
    "BootstrapVersion": {
      "Type": "AWS::SSM::Parameter::Value<String>",
      "Default": "/cdk-bootstrap/hnb659fds/version",
      "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
    }
  },
  "Outputs": {
    "dns1": {
      "Value": {
        "Fn::GetAtt": [
          "GetEndpointIps4AECBE9C",
          "NetworkInterfaces.0.PrivateIpAddress"
        ]
      }
    },
    "dns2": {
      "Value": {
        "Fn::GetAtt": [
          "GetEndpointIps4AECBE9C",
          "NetworkInterfaces.1.PrivateIpAddress"
        ]
      }
    },
    "adminurl": {
      "Value": "http://pi.hole/admin"
    },
    "SecretArn": {
      "Value": {
        "Ref": "piholepwd34137309"
      }
    },
    "RFC1918PrefixListId": {
      "Value": {
        "Fn::GetAtt": [
          "rfc1918prefix",
          "PrefixListId"
        ]
      },
      "Export": {
        "Name": "RFC1918PrefixListId"
      }
    }
  },
  "Rules": {
    "CheckBootstrapVersion": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Contains": [
                  [
                    "1",
                    "2",
                    "3",
                    "4",
                    "5"
                  ],
                  {
                    "Ref": "BootstrapVersion"
                  }
                ]
              }
            ]
          },
          "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
        }
      ]
    }
  }
}