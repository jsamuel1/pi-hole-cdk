name: Multiregion_SiteToSiteVPN_Deploy

# üè¥‚Äç‚ò†Ô∏è This workflow deploys Site-to-Site VPN stacks to multiple AWS regions
# Arrr! Manual trigger only, fer when ye need VPN connectivity, matey!
on:
  workflow_dispatch:  # Manual trigger only

# Run exclusively on self-hosted runners with pi-hole-cdk label
# The runners be configured in the target AWS account with CDK deployment permissions
jobs:
  # Bootstrap and Deploy to Sydney (ap-southeast-2) üó∫Ô∏è
  deploy-sydney:
    name: Deploy Site-to-Site VPN to Sydney (ap-southeast-2)
    runs-on: [self-hosted, pi-hole-cdk]
    env:
      AWS_REGION: ap-southeast-2
      CDK_DEFAULT_REGION: ap-southeast-2
    steps:
      - name: Checkout code ‚öì
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap Sydney
        run: |
          npx cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: CDK Synth - Verify template
        run: |
          npx cdk synth SiteToSiteVpnStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}"

      - name: Deploy SiteToSiteVpnStack to Sydney üö¢
        run: |
          npx cdk deploy SiteToSiteVpnStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --require-approval never

  # Bootstrap and Deploy to Melbourne (ap-southeast-4) üó∫Ô∏è
  deploy-melbourne:
    name: Deploy Site-to-Site VPN to Melbourne (ap-southeast-4)
    runs-on: [self-hosted, pi-hole-cdk]
    env:
      AWS_REGION: ap-southeast-4
      CDK_DEFAULT_REGION: ap-southeast-4
    steps:
      - name: Checkout code ‚öì
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap Melbourne
        run: |
          npx cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: CDK Synth - Verify template
        run: |
          npx cdk synth SiteToSiteVpnStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}"

      - name: Deploy SiteToSiteVpnStack to Melbourne üö¢
        run: |
          npx cdk deploy SiteToSiteVpnStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --require-approval never
