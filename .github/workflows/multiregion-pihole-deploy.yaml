name: Multiregion_PiHole_Deploy

# This workflow deploys Pi-hole stack to multiple AWS regions
on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: pi-hole-deploy
  cancel-in-progress: false

jobs:
  deploy-melbourne:
    name: Deploy to Melbourne (ap-southeast-4)
    runs-on: [self-hosted, pi-hole-cdk]
    env:
      AWS_REGION: ap-southeast-4
      CDK_DEFAULT_REGION: ap-southeast-4
      CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap Melbourne
        run: |
          npx cdk --no-notices bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: CDK Synth - Verify templates
        run: |
          npx cdk --no-notices synth PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --context vpc_name="${{ secrets.VPC_NAME_MELBOURNE }}" \
            --context rev_server_target="${{ secrets.REV_SERVER_TARGET }}" \
            --context https_enabled=true \
            --context hosted_zone_id="${{ secrets.HOSTED_ZONE_ID }}" \
            --context hosted_zone_name="${{ secrets.HOSTED_ZONE_NAME }}" \
            --context region_subdomain=mel

      - name: Deploy PiHoleCdkStack to Melbourne
        run: |
          npx cdk --no-notices deploy PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --context vpc_name="${{ secrets.VPC_NAME_MELBOURNE }}" \
            --context rev_server_target="${{ secrets.REV_SERVER_TARGET }}" \
            --context https_enabled=true \
            --context hosted_zone_id="${{ secrets.HOSTED_ZONE_ID }}" \
            --context hosted_zone_name="${{ secrets.HOSTED_ZONE_NAME }}" \
            --context region_subdomain=mel \
            --require-approval never

  deploy-sydney:
    needs: deploy-melbourne
    name: Deploy to Sydney (ap-southeast-2)
    runs-on: [self-hosted, pi-hole-cdk]
    env:
      AWS_REGION: ap-southeast-2
      CDK_DEFAULT_REGION: ap-southeast-2
      CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap Sydney
        run: |
          npx cdk --no-notices bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: CDK Synth - Verify templates
        run: |
          npx cdk --no-notices synth PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --context vpc_name="${{ secrets.VPC_NAME_SYDNEY }}" \
            --context rev_server_target="${{ secrets.REV_SERVER_TARGET }}" \
            --context https_enabled=true \
            --context hosted_zone_id="${{ secrets.HOSTED_ZONE_ID }}" \
            --context hosted_zone_name="${{ secrets.HOSTED_ZONE_NAME }}" \
            --context region_subdomain=syd

      - name: Deploy PiHoleCdkStack to Sydney
        run: |
          npx cdk --no-notices deploy PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --context vpc_name="${{ secrets.VPC_NAME_SYDNEY }}" \
            --context rev_server_target="${{ secrets.REV_SERVER_TARGET }}" \
            --context https_enabled=true \
            --context hosted_zone_id="${{ secrets.HOSTED_ZONE_ID }}" \
            --context hosted_zone_name="${{ secrets.HOSTED_ZONE_NAME }}" \
            --context region_subdomain=syd \
            --require-approval never

  deploy-san-francisco:
    needs: deploy-sydney
    name: Deploy to San Francisco (us-west-1)
    runs-on: [self-hosted, pi-hole-cdk]
    env:
      AWS_REGION: us-west-1
      CDK_DEFAULT_REGION: us-west-1
      CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap San Francisco
        run: |
          npx cdk --no-notices bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: CDK Synth - Verify templates
        run: |
          npx cdk --no-notices synth PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --context vpc_name="${{ secrets.VPC_NAME_SAN_FRANCISCO }}" \
            --context rev_server_target="${{ secrets.REV_SERVER_TARGET }}" \
            --context https_enabled=true \
            --context hosted_zone_id="${{ secrets.HOSTED_ZONE_ID }}" \
            --context hosted_zone_name="${{ secrets.HOSTED_ZONE_NAME }}" \
            --context region_subdomain=sfo

      - name: Deploy PiHoleCdkStack to San Francisco
        run: |
          npx cdk --no-notices deploy PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --context vpc_name="${{ secrets.VPC_NAME_SAN_FRANCISCO }}" \
            --context rev_server_target="${{ secrets.REV_SERVER_TARGET }}" \
            --context https_enabled=true \
            --context hosted_zone_id="${{ secrets.HOSTED_ZONE_ID }}" \
            --context hosted_zone_name="${{ secrets.HOSTED_ZONE_NAME }}" \
            --context region_subdomain=sfo \
            --require-approval never
