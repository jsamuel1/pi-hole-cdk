name: Multiregion_PiHole_Deploy

# This workflow deploys Pi-hole stack to multiple AWS regions
on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: pi-hole-deploy
  cancel-in-progress: false

jobs:
  deploy-melbourne:
    name: Deploy to Melbourne (ap-southeast-4)
    runs-on: pi-hole-cdk
    outputs:
      alb_dns: ${{ steps.deploy.outputs.alb_dns }}
      alb_zone: ${{ steps.deploy.outputs.alb_zone }}
    env:
      AWS_REGION: ap-southeast-4
      CDK_DEFAULT_REGION: ap-southeast-4
      CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap Melbourne
        run: |
          npx cdk --no-notices bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: Lookup existing EFS replication
        id: efs_lookup
        run: |
          # Get the EFS filesystem ID from CloudFormation
          FS_ID=$(aws cloudformation describe-stack-resources \
            --stack-name PiHoleCdkStack \
            --query "StackResources[?ResourceType=='AWS::EFS::FileSystem'].PhysicalResourceId" \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$FS_ID" ]; then
            # Check if replication exists
            DEST_FS_ID=$(aws efs describe-replication-configurations \
              --file-system-id "$FS_ID" \
              --query 'Replications[0].Destinations[0].FileSystemId' \
              --output text 2>/dev/null || echo "")
            
            if [ -n "$DEST_FS_ID" ] && [ "$DEST_FS_ID" != "None" ]; then
              echo "dest_fs_id=$DEST_FS_ID" >> $GITHUB_OUTPUT
              echo "Found existing replication destination: $DEST_FS_ID"
            fi
          fi

      - name: Deploy PiHoleCdkStack to Melbourne
        id: deploy
        run: |
          REPL_ARGS=""
          if [ -n "${{ steps.efs_lookup.outputs.dest_fs_id }}" ]; then
            REPL_ARGS="--context efs_replication_dest_fs_id=${{ steps.efs_lookup.outputs.dest_fs_id }}"
          fi
          
          npx cdk --no-notices deploy PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --context vpc_name="${{ secrets.VPC_NAME_MELBOURNE }}" \
            --context rev_server_target="${{ secrets.REV_SERVER_TARGET }}" \
            --context https_enabled=true \
            --context hosted_zone_name="${{ secrets.HOSTED_ZONE_NAME }}" \
            --context region_subdomain=mel \
            --context certificate_arn="${{ secrets.CERTIFICATE_ARN_MEL }}" \
            --context external_cognito_user_pool_arn="${{ secrets.EXTERNAL_COGNITO_USER_POOL_ARN }}" \
            --context external_cognito_client_id="${{ secrets.EXTERNAL_COGNITO_CLIENT_ID }}" \
            --context external_cognito_client_secret="${{ secrets.EXTERNAL_COGNITO_CLIENT_SECRET }}" \
            --context external_cognito_domain="${{ secrets.EXTERNAL_COGNITO_DOMAIN }}" \
            --context efs_replication_region="ap-southeast-2" \
            --context local_dns_suffix="${{ secrets.LOCAL_DNS_SUFFIX }}" \
            --context unifi_base_url="${{ secrets.UNIFI_BASE_URL }}" \
            --context unifi_site_id="default" \
            --context pihole_api_url="${{ secrets.PIHOLE_API_URL }}" \
            --context home_assistant_ip="${{ secrets.HOME_ASSISTANT_IP }}" \
            --context api_allowed_cidrs="0.0.0.0/0" \
            $REPL_ARGS \
            --outputs-file outputs.json \
            --require-approval never
          echo "alb_dns=$(jq -r '.PiHoleCdkStack.AlbDnsName // empty' outputs.json)" >> $GITHUB_OUTPUT
          echo "alb_zone=$(jq -r '.PiHoleCdkStack.AlbHostedZoneId // empty' outputs.json)" >> $GITHUB_OUTPUT

      - name: Deploy UnifiDnsSyncStack to Melbourne
        run: |
          REPL_ARGS=""
          if [ -n "${{ steps.efs_lookup.outputs.dest_fs_id }}" ]; then
            REPL_ARGS="--context efs_replication_dest_fs_id=${{ steps.efs_lookup.outputs.dest_fs_id }}"
          fi
          
          npx cdk --no-notices deploy UnifiDnsSyncStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --context vpc_name="${{ secrets.VPC_NAME_MELBOURNE }}" \
            --context rev_server_target="${{ secrets.REV_SERVER_TARGET }}" \
            --context https_enabled=true \
            --context hosted_zone_name="${{ secrets.HOSTED_ZONE_NAME }}" \
            --context region_subdomain=mel \
            --context certificate_arn="${{ secrets.CERTIFICATE_ARN_MEL }}" \
            --context external_cognito_user_pool_arn="${{ secrets.EXTERNAL_COGNITO_USER_POOL_ARN }}" \
            --context external_cognito_client_id="${{ secrets.EXTERNAL_COGNITO_CLIENT_ID }}" \
            --context external_cognito_client_secret="${{ secrets.EXTERNAL_COGNITO_CLIENT_SECRET }}" \
            --context external_cognito_domain="${{ secrets.EXTERNAL_COGNITO_DOMAIN }}" \
            --context efs_replication_region="ap-southeast-2" \
            --context local_dns_suffix="${{ secrets.LOCAL_DNS_SUFFIX }}" \
            --context unifi_base_url="${{ secrets.UNIFI_BASE_URL }}" \
            --context unifi_site_id="default" \
            --context pihole_api_url="${{ secrets.PIHOLE_API_URL }}" \
            --context home_assistant_ip="${{ secrets.HOME_ASSISTANT_IP }}" \
            --context api_cognito_client_id="${{ secrets.API_COGNITO_CLIENT_ID }}" \
            $REPL_ARGS \
            --require-approval never

  deploy-sydney:
    needs: deploy-melbourne
    name: Deploy to Sydney (ap-southeast-2)
    runs-on: pi-hole-cdk
    outputs:
      alb_dns: ${{ steps.deploy.outputs.alb_dns }}
      alb_zone: ${{ steps.deploy.outputs.alb_zone }}
    env:
      AWS_REGION: ap-southeast-2
      CDK_DEFAULT_REGION: ap-southeast-2
      CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap Sydney
        run: |
          npx cdk --no-notices bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: Deploy PiHoleCdkStack to Sydney
        id: deploy
        run: |
          npx cdk --no-notices deploy PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --context vpc_name="${{ secrets.VPC_NAME_SYDNEY }}" \
            --context rev_server_target="${{ secrets.REV_SERVER_TARGET }}" \
            --context https_enabled=true \
            --context hosted_zone_name="${{ secrets.HOSTED_ZONE_NAME }}" \
            --context region_subdomain=syd \
            --context certificate_arn="${{ secrets.CERTIFICATE_ARN_SYD }}" \
            --context external_cognito_user_pool_arn="${{ secrets.EXTERNAL_COGNITO_USER_POOL_ARN }}" \
            --context external_cognito_client_id="${{ secrets.EXTERNAL_COGNITO_CLIENT_ID }}" \
            --context external_cognito_client_secret="${{ secrets.EXTERNAL_COGNITO_CLIENT_SECRET }}" \
            --context external_cognito_domain="${{ secrets.EXTERNAL_COGNITO_DOMAIN }}" \
            --context local_dns_suffix="${{ secrets.LOCAL_DNS_SUFFIX }}" \
            --outputs-file outputs.json \
            --require-approval never
          echo "alb_dns=$(jq -r '.PiHoleCdkStack.AlbDnsName // empty' outputs.json)" >> $GITHUB_OUTPUT
          echo "alb_zone=$(jq -r '.PiHoleCdkStack.AlbHostedZoneId // empty' outputs.json)" >> $GITHUB_OUTPUT

  # Failover DNS records are managed in cognito-account-portal stack (sauhsoj-dev-ct account)
  # where the home.sauhsoj.wtf hosted zone lives
