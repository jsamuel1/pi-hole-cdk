name: Multiregion_PiHole_Deploy

# üè¥‚Äç‚ò†Ô∏è This workflow deploys Pi-hole stacks to multiple AWS regions
# Arrr! Automatically triggers on push to main branch, matey!
on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual trigger fer on-demand deployments

# Limit to 1 concurrent job to prevent OOM on self-hosted runners
concurrency:
  group: pi-hole-deploy
  cancel-in-progress: false

# Run exclusively on self-hosted runners with pi-hole-cdk label
# The runners be configured in the target AWS account with CDK deployment permissions
jobs:
  # Bootstrap and Deploy to Sydney (ap-southeast-2) üó∫Ô∏è
  deploy-sydney:
    needs: deploy-melbourne
    name: Deploy to Sydney (ap-southeast-2)
    runs-on: [self-hosted, pi-hole-cdk]
    env:
      AWS_REGION: ap-southeast-2
      CDK_DEFAULT_REGION: ap-southeast-2
    steps:
      - name: Checkout code ‚öì
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap Sydney
        run: |
          npx cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: CDK Synth - Verify templates
        run: |
          npx cdk synth PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}"
          npx cdk synth PiHoleEcsManagedStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}"

      - name: Deploy Original EC2 Stack (PiHoleCdkStack) to Sydney üö¢
        run: |
          npx cdk deploy PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --require-approval never

      - name: Deploy ECS Stack (PiHoleEcsManagedStack) to Sydney ‚öì
        run: |
          npx cdk deploy PiHoleEcsManagedStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --require-approval never

  # Bootstrap and Deploy to Melbourne (ap-southeast-4) üó∫Ô∏è
  deploy-melbourne:
    name: Deploy to Melbourne (ap-southeast-4)
    runs-on: [self-hosted, pi-hole-cdk]
    env:
      AWS_REGION: ap-southeast-4
      CDK_DEFAULT_REGION: ap-southeast-4
    steps:
      - name: Checkout code ‚öì
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap Melbourne
        run: |
          npx cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: CDK Synth - Verify templates
        run: |
          npx cdk synth PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}"
          npx cdk synth PiHoleEcsManagedStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}"

      - name: Deploy Original EC2 Stack (PiHoleCdkStack) to Melbourne üö¢
        run: |
          npx cdk deploy PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --require-approval never

      - name: Deploy ECS Stack (PiHoleEcsManagedStack) to Melbourne ‚öì
        run: |
          npx cdk deploy PiHoleEcsManagedStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --require-approval never

  # Bootstrap and Deploy to San Francisco (us-west-1) üó∫Ô∏è
  deploy-san-francisco:
    needs: deploy-sydney
    name: Deploy to San Francisco (us-west-1)
    runs-on: [self-hosted, pi-hole-cdk]
    env:
      AWS_REGION: us-west-1
      CDK_DEFAULT_REGION: us-west-1
    steps:
      - name: Checkout code ‚öì
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap San Francisco
        run: |
          npx cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: CDK Synth - Verify templates
        run: |
          npx cdk synth PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}"
          npx cdk synth PiHoleEcsManagedStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}"

      - name: Deploy Original EC2 Stack (PiHoleCdkStack) to San Francisco üö¢
        run: |
          npx cdk deploy PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --require-approval never

      - name: Deploy ECS Stack (PiHoleEcsManagedStack) to San Francisco ‚öì
        run: |
          npx cdk deploy PiHoleEcsManagedStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --require-approval never
