name: Multiregion_PiHole_Deploy

# This workflow deploys Pi-hole stack to multiple AWS regions
on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: pi-hole-deploy
  cancel-in-progress: false

jobs:
  deploy-melbourne:
    name: Deploy to Melbourne (ap-southeast-4)
    runs-on: [self-hosted, pi-hole-cdk]
    outputs:
      alb_dns: ${{ steps.deploy.outputs.alb_dns }}
      alb_zone: ${{ steps.deploy.outputs.alb_zone }}
    env:
      AWS_REGION: ap-southeast-4
      CDK_DEFAULT_REGION: ap-southeast-4
      CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap Melbourne
        run: |
          npx cdk --no-notices bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: Lookup existing EFS replication
        id: efs_lookup
        run: |
          # Get the EFS filesystem ID from CloudFormation
          FS_ID=$(aws cloudformation describe-stack-resources \
            --stack-name PiHoleCdkStack \
            --query "StackResources[?ResourceType=='AWS::EFS::FileSystem'].PhysicalResourceId" \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$FS_ID" ]; then
            # Check if replication exists
            DEST_FS_ID=$(aws efs describe-replication-configurations \
              --file-system-id "$FS_ID" \
              --query 'Replications[0].Destinations[0].FileSystemId' \
              --output text 2>/dev/null || echo "")
            
            if [ -n "$DEST_FS_ID" ] && [ "$DEST_FS_ID" != "None" ]; then
              echo "dest_fs_id=$DEST_FS_ID" >> $GITHUB_OUTPUT
              echo "Found existing replication destination: $DEST_FS_ID"
            fi
          fi

      - name: Deploy PiHoleCdkStack to Melbourne
        id: deploy
        run: |
          REPL_ARGS=""
          if [ -n "${{ steps.efs_lookup.outputs.dest_fs_id }}" ]; then
            REPL_ARGS="--context efs_replication_dest_fs_id=${{ steps.efs_lookup.outputs.dest_fs_id }}"
          fi
          
          npx cdk --no-notices deploy PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --context vpc_name="${{ secrets.VPC_NAME_MELBOURNE }}" \
            --context rev_server_target="${{ secrets.REV_SERVER_TARGET }}" \
            --context https_enabled=true \
            --context hosted_zone_id="${{ secrets.HOSTED_ZONE_ID }}" \
            --context hosted_zone_name="${{ secrets.HOSTED_ZONE_NAME }}" \
            --context region_subdomain=mel \
            --context efs_replication_region="ap-southeast-2" \
            $REPL_ARGS \
            --outputs-file outputs.json \
            --require-approval never
          echo "alb_dns=$(jq -r '.PiHoleCdkStack.AlbDnsName // empty' outputs.json)" >> $GITHUB_OUTPUT
          echo "alb_zone=$(jq -r '.PiHoleCdkStack.AlbHostedZoneId // empty' outputs.json)" >> $GITHUB_OUTPUT

  deploy-sydney:
    needs: deploy-melbourne
    name: Deploy to Sydney (ap-southeast-2)
    runs-on: [self-hosted, pi-hole-cdk]
    outputs:
      alb_dns: ${{ steps.deploy.outputs.alb_dns }}
      alb_zone: ${{ steps.deploy.outputs.alb_zone }}
    env:
      AWS_REGION: ap-southeast-2
      CDK_DEFAULT_REGION: ap-southeast-2
      CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap Sydney
        run: |
          npx cdk --no-notices bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: Deploy PiHoleCdkStack to Sydney
        id: deploy
        run: |
          npx cdk --no-notices deploy PiHoleCdkStack \
            --context local_ip="${{ secrets.LOCAL_IP }}" \
            --context local_internal_cidr="${{ secrets.LOCAL_INTERNAL_CIDR }}" \
            --context vpc_name="${{ secrets.VPC_NAME_SYDNEY }}" \
            --context rev_server_target="${{ secrets.REV_SERVER_TARGET }}" \
            --context https_enabled=true \
            --context hosted_zone_id="${{ secrets.HOSTED_ZONE_ID }}" \
            --context hosted_zone_name="${{ secrets.HOSTED_ZONE_NAME }}" \
            --context region_subdomain=syd \
            --outputs-file outputs.json \
            --require-approval never
          echo "alb_dns=$(jq -r '.PiHoleCdkStack.AlbDnsName // empty' outputs.json)" >> $GITHUB_OUTPUT
          echo "alb_zone=$(jq -r '.PiHoleCdkStack.AlbHostedZoneId // empty' outputs.json)" >> $GITHUB_OUTPUT

  deploy-failover:
    needs: [deploy-melbourne, deploy-sydney]
    name: Deploy Route 53 Failover
    runs-on: [self-hosted, pi-hole-cdk]
    env:
      AWS_REGION: us-east-1
      CDK_DEFAULT_REGION: us-east-1
      CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: CDK Bootstrap us-east-1
        run: |
          npx cdk --no-notices bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }}

      - name: Deploy PiHoleFailoverStack
        run: |
          npx cdk --no-notices deploy PiHoleFailoverStack \
            --context hosted_zone_id="${{ secrets.HOSTED_ZONE_ID }}" \
            --context hosted_zone_name="${{ secrets.HOSTED_ZONE_NAME }}" \
            --context mel_alb_dns="${{ needs.deploy-melbourne.outputs.alb_dns }}" \
            --context mel_alb_zone="${{ needs.deploy-melbourne.outputs.alb_zone }}" \
            --context syd_alb_dns="${{ needs.deploy-sydney.outputs.alb_dns }}" \
            --context syd_alb_zone="${{ needs.deploy-sydney.outputs.alb_zone }}" \
            --require-approval never
